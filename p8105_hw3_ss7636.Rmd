---
title: "p8105_hw3_ss7636"
output: html_document
date: "2025-10-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 1

```{r}
library(p8105.datasets)
data("instacart")
instacart
```
The dataset contains 1,384,617 observations of 131,209 unique users, where each row in the dataset is a product from an order. There is a single order per user in this dataset. There are 15 variables in this dataset, and a couple key important variables are order_id: order identifier, product_id: product identifier, and add_to_cart_order: order in which each product was added to cart

```{r}
n_aisles = instacart |> 
  summarize(n_aisles = n_distinct(aisle)) |> 
  pull(n_aisles)

n_aisles

```

```{r}
intacart_items_ordered = instacart |> 
  count(aisle, name = "items_ordered") |> 
  arrange(desc(items_ordered))

intacart_items_ordered
```

There are 134 aisles and most items are ordered from the fresh vegetables and fresh fruits sections. 

```{r}
intacart_items_ordered  |> 
  filter(items_ordered > 10000) |> 
  ggplot(aes(x = reorder(aisle, -items_ordered), y = items_ordered)) + 
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotate labels
  labs(title = "Items Ordered per Aisle (Above 10,000 Orders)",
       x = "Aisle",
       y = "Number of Items Ordered")

intacart_items_ordered
  
```

```{r}
top_3_items = instacart |> 
  filter(aisle == c("baking ingredients", "dog food care", "packaged vegetables fruits")) |> 
  select(aisle, product_name) |> 
  group_by(aisle, product_name) |> 
  summarize(n_orders = n()) |> 
  arrange(aisle, desc(n_orders)) |> 
  filter(row_number() <= 3) 

top_3_items
```

```{r}
knitr::kable(top_3_items)
```


```{r}
mean_hour = instacart |> 
  filter(product_name == c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  select(product_name, order_hour_of_day, order_dow) |> 
  group_by(product_name, order_dow) |> 
  summarize(mean_hour = round(mean(order_hour_of_day), 2)) |> 
  pivot_wider (
    names_from = "order_dow",
    values_from = "mean_hour"
  )

mean_hour
```
```{r}
knitr::kable(mean_hour)
```

## Question 2

```{r}
#Import and clean zipcodes dataset. Remove irrelevant columns, such as state_fips and file_date. 
zipcodes = 
 read_csv("zillow_data/Zip Codes.csv", na = c("NA",".", "")) |> 
  janitor :: clean_names() |> 
  select(-"state_fips", -"file_date")  
zipcodes
```

```{r}
#Import zillow dataset and analyze what needs to be changed.
zillow = 
 read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv", na = c("NA",".", "")) |> 
  janitor:: clean_names() 
zillow
```

```{r}
#Clean zillow dataset. Pivot longer the dates, showing the rent values on zillow. Removing irrelelvent columns. Changing the name of region_name to zip_code so it can match up with the name in the zipcodes dataset. Removing the "County" text in the county_name column, so the format can match up with the county names in the zipcodes dataset. Also want to rename county_name to county so I can join the dataset by zipcode and county. 
zillow = 
 read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv", na = c("NA",".", "")) |> 
  janitor:: clean_names() |> 
  pivot_longer(
    cols = x2015_01_31:x2024_08_31,       
    names_to = "date",  
    values_to = "zori"   
  ) |> 
  mutate(
    date = str_remove(date, "x")
  ) |> 
  select(-"city", -"metro", -"region_type",  -"state_name", -"state") |> 
  rename(zip_code = region_name) |> 
  mutate(
    county_name = str_remove(county_name, " County")
  ) |> 
  rename(county = county_name)
zillow
```
```{r}
joined_zipcodes_nyc = left_join(zipcodes, zillow, by = c("zip_code", "county"))
joined_zipcodes_nyc
```
```{r}
joined_zipcodes_nyc |> 
  group_by(zip_code) |> 
  summarize(n_obs = n()) |> 
  summarize(n_equal_116 = sum(n_obs == 116)) |> 
  pull(n_equal_116)

```

There are 146 zipcodes that are observed 116 times. 

```{r}
joined_zipcodes_nyc |> 
  group_by(zip_code) |> 
  summarize(n_obs = n()) |> 
  summarize(n_fewer_10 = sum(n_obs < 10)) |> 
  pull(n_fewer_10)
```

There are 172 zipcodes that are observed fewer than 10 times. 

We might see this because it is possible that many zipcodes are in regions that are not inhabitable, for example in area of reserve or significant landmarks that would not have a rental listing.

```{r}
joined_zipcodes_nyc_average_rent_year = joined_zipcodes_nyc |> 
  separate(date, into = c("year", "month", "day"), sep = "_") |> 
  mutate(
    year = as.integer(year),
    month = as.integer(month),
    day = as.integer(day)
  ) |> 
  drop_na(zori) |> 
  select(county, year, zori, zip_code) |> 
  group_by(county, year) |> 
  summarize(average_rental_price = mean(zori))

joined_zipcodes_nyc_average_rent_year

knitr::kable(joined_zipcodes_nyc_average_rent_year)
```

Average rent prices are going up 
```{r}
rent_price_by_county = joined_zipcodes_nyc_average_rent_year |> 
  ggplot(aes(x = factor(year), y = average_rental_price, color = county, group = county)) + 
  geom_point(alpha = 0.5) +
  labs(title = "NYC Rental Prices Across ZIP Codes by Borough",
       x = "Year",
       y = "Average Rent Price ($)") + 
  geom_line()

rent_price_by_county
```

New York had the average highest rent price across all the years from 2015-2024, probably because it is one of the most touristy areas, and the Bronx had the lowest average rent price across the years 2015-2024. New York, Kings, and Queens all experiences a slight dip around 2020, which makes sense due to COVID-19, and then have been on the rise since 2021. Richmond only has recorded average rent price values after 2020, and it seems to consistently be going up. 

```{r}
joined_zipcodes_nyc_average_rent_by_month_2023 = joined_zipcodes_nyc |> 
  separate(date, into = c("year", "month", "day"), sep = "_") |> 
  mutate(
    year = as.integer(year),
    month = as.integer(month),
    day = as.integer(day)
  ) |> 
  drop_na(zori) |> 
  filter(year == 2023) |> 
  select(county, month, zori, zip_code) |> 
  group_by(month, county, zip_code) |> 
  summarize(average_rent = mean(zori))

joined_zipcodes_nyc_average_rent_by_month_2023
```
```{r}
joined_zipcodes_nyc_average_rent_by_month_2023_plot = 
joined_zipcodes_nyc_average_rent_by_month_2023 |> 
  ggplot(aes(x = county, y = average_rent, fill = county)) +
  geom_violin(alpha = 0.7) +
  labs(
    title = "Distribution of ZIP-Code-Level Rental Prices Across NYC Boroughs (2023)",
    x = "Borough",
    y = "Average Monthly Rent ($)"
  ) 

joined_zipcodes_nyc_average_rent_by_month_2023_plot
```

```{r}
combined_plot = rent_price_by_county | joined_zipcodes_nyc_average_rent_by_month_2023_plot
ggsave("results/combined_plot.png",
       combined_plot)
```


